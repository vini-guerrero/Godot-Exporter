name: Export
on:
  push:
    branches: [main]

env:
  EXPORT_NAME: game
  GODOT_VERSION: 3.3.1
  GODOT_DL_SUBDIR: 3.3.1
  GODOT_RELEASE: stable

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup Dependencies
        working-directory: .
        run: |
          chmod +x ./setup.sh && sudo ./setup.sh
      - name: Prepare Export
        env:
          ANDROID_HOME: /root/android-sdk
        run: |
          wget https://downloads.tuxfamily.org/godotengine/${GODOT_DL_SUBDIR}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_linux_headless.64.zip \
          && wget https://downloads.tuxfamily.org/godotengine/${GODOT_DL_SUBDIR}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_export_templates.tpz \
          && mkdir -v ~/.cache \
          && mkdir -p -v ~/.config/godot \
          && mkdir -p -v ~/.local/share/godot/templates/${GODOT_VERSION}.${GODOT_RELEASE} \
          && unzip Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_linux_headless.64.zip \
          && sudo mv Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_linux_headless.64 /usr/local/bin/godot \
          && unzip Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_export_templates.tpz \
          && sudo mv templates/* ~/.local/share/godot/templates/${GODOT_VERSION}.${GODOT_RELEASE} \
          && sudo rm -f Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_export_templates.tpz Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_linux_headless.64.zip

          sudo mkdir -p -v /root/android-sdk-installer/cmdline-tools \
          && sudo chmod -R 777 /root
          && cd /root/android-sdk-installer/cmdline-tools \
          && curl -fsSLO "https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip" \
          && unzip -q commandlinetools-linux-*.zip \
          && sudo rm commandlinetools-linux-*.zip \
          && sudo mv cmdline-tools latest \
          && sudo mkdir -p -v /root/.android \
          && sudo echo "count=0" > /root/.android/repositories.cfg \
          && yes | /root/android-sdk-installer/cmdline-tools/latest/bin/sdkmanager --licenses \
          && yes | /root/android-sdk-installer/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "build-tools;30.0.3" "platforms;android-29" "cmdline-tools;latest" "cmake;3.10.2.4988404" "ndk;21.4.7075529" \
          && sudo rm -rf /root/android-sdk-installer

          && keytool -keyalg RSA -genkeypair -alias androiddebugkey -keypass android -keystore debug.keystore -storepass android -dname "CN=Android Debug,O=Android,C=US" -validity 9999 \
          && ls
          && pwd
          && sudo mv debug.keystore /root/android-sdk/debug.keystore
    # container:
    #   image: viiniiguerrero/godot_ci:latest
    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v1
    #   - name: Setup
    #     run: |
    #       mkdir -v -p ~/.local/share/godot/templates
    #       mv /root/.local/share/godot/templates/${GODOT_VERSION}.stable ~/.local/share/godot/templates/${GODOT_VERSION}.stable
    #       mkdir -v -p ~/.config/godot/
    #       cp /root/.config/godot/editor_settings-3.tres ~/.config/godot/editor_settings-3.tres
    #       echo 'export/android/debug_keystore = "/root/android-sdk/debug.keystore"' >> ~/.config/godot/editor_settings-3.tres
    #       echo 'export/android/android_sdk_path = "/root/android-sdk"' >> ~/.config/godot/editor_settings-3.tres
    #   - name: Android Debug Build
    #     run: |
    #       cd game
    #       mkdir -v -p build/android
    #       godot --verbose --export-debug "Android" ./build/android/$EXPORT_NAME.debug.apk
    #   - uses: actions/upload-artifact@v1
    #     with:
    #       name: android
    #       path: game/build/android
